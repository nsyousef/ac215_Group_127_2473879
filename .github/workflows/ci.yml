# GitHub Actions CI/CD Pipeline
# Runs on every push and pull request to main branch
# All tests run inside Docker container for consistency

name: CI Pipeline

on:
  push:
    # run on push to any branch
  pull_request:
    branches: [main]

jobs:
  # Job 1: Build All Microservice Images
  build:
    name: Build Microservices
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: [data-processor, llm] # frontend-react, ml_workflow, inference-cloud]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build ${{ matrix.service }} image
        env:
          GCS_CREDENTIALS_JSON: ${{ secrets.GCS_CREDENTIALS_JSON }}
        run: |
          if [ "${{ matrix.service }}" = "data-processor" ]; then
            cd src/${{ matrix.service }}

            # Create secrets directory if it doesn't exist
            mkdir -p ../../../secrets

            # If GitHub secret exists, write it; otherwise create empty file
            if [ -n "$GCS_CREDENTIALS_JSON" ]; then
              printf '%s' "$GCS_CREDENTIALS_JSON" > ../../../secrets/gcs-key.json
            else
              echo '{}' > ../../../secrets/gcs-key.json
            fi

            docker build -t ${{ matrix.service }}:${{ github.sha }} -f Dockerfile.ci ../../..
          elif [ "${{ matrix.service }}" = "frontend-react" ]; then
            cd src/${{ matrix.service }}
            docker build -t ${{ matrix.service }}:${{ github.sha }} -f Dockerfile.ci .
          elif [ "${{ matrix.service }}" = "llm" ]; then
            cd src/${{ matrix.service }}
            docker build -t ${{ matrix.service }}:${{ github.sha }} -f Dockerfile.ci .
          else
            cd src/${{ matrix.service }}
            docker build -t ${{ matrix.service }}:${{ github.sha }} -f Dockerfile .
          fi
        continue-on-error: true

      - name: Save Docker image
        run: |
          docker save ${{ matrix.service }}:${{ github.sha }} -o /tmp/${{ matrix.service }}.tar || true
      - name: Upload Docker image artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-image-${{ matrix.service }}
          path: /tmp/${{ matrix.service }}.tar
          retention-days: 1
        if: always()

  # Job 2: Run linting and formatting checks
  lint-and-format:
    name: Lint and Format Check ${{ matrix.service }}
    runs-on: ubuntu-latest
    needs: build
    strategy:
      matrix:
        service: [data-processor, llm] # frontend-react, ml_workflow, inference-cloud]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Docker image
        uses: actions/download-artifact@v4
        with:
          name: docker-image-${{ matrix.service }}
          path: /tmp
        continue-on-error: true

      - name: Check if Docker image exists
        run: |
          if [ ! -f /tmp/${{ matrix.service }}.tar ]; then
            echo "❌ Docker image not found for ${{ matrix.service }}"
            exit 1
          fi

      - name: Load Docker image
        run: |
          docker load -i /tmp/${{ matrix.service }}.tar
        continue-on-error: false

      - name: Run Black formatter check for ${{ matrix.service }}
        run: |
          case "${{ matrix.service }}" in
            frontend-react)
              echo "Skipping Python linting for frontend service"
              ;;
            *)
              docker run --rm --entrypoint /bin/bash -v $PWD:/workspace ${{ matrix.service }}:${{ github.sha }} -c "source /app/.venv/bin/activate && black --check --line-length 120 /workspace"
              ;;
          esac
        continue-on-error: true

      - name: Run Flake8 linter for ${{ matrix.service }}
        run: |
          case "${{ matrix.service }}" in
            frontend-react)
              echo "Skipping Python linting for frontend service"
              ;;
            *)
              docker run --rm --entrypoint /bin/bash -v $PWD:/workspace ${{ matrix.service }}:${{ github.sha }} -c "source /app/.venv/bin/activate && flake8 --max-line-length=120 --extend-ignore=E203,W503 /workspace"
              ;;
          esac
        continue-on-error: true

  # Job 3: Run unit tests
  unit-tests:
    name: Unit Tests ${{ matrix.service }}
    runs-on: ubuntu-latest
    needs: build
    strategy:
      matrix:
        service: [data-processor, llm]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Docker image
        uses: actions/download-artifact@v4
        with:
          name: docker-image-${{ matrix.service }}
          path: /tmp
        continue-on-error: true

      - name: Check if Docker image exists
        run: |
          if [ ! -f /tmp/${{ matrix.service }}.tar ]; then
            echo "⚠️ Docker image not found for ${{ matrix.service }}, skipping tests"
            exit 0
          fi

      - name: Load Docker image
        run: |
          docker load -i /tmp/${{ matrix.service }}.tar
        continue-on-error: true

      - name: Run unit tests for ${{ matrix.service }}
        run: |
          case "${{ matrix.service }}" in
            data-processor|ml_workflow|inference-cloud|llm)
              docker run --rm --entrypoint /bin/bash -v $PWD:/workspace ${{ matrix.service }}:${{ github.sha }} -c "source /app/.venv/bin/activate && pytest tests/ -v --tb=short -m 'not integration'" || echo "⚠️ No tests found or tests failed for ${{ matrix.service }}"
              ;;
            frontend-react)
              docker run --rm -v $PWD:/workspace ${{ matrix.service }}:${{ github.sha }} npm test || echo "⚠️ No tests found or tests failed for ${{ matrix.service }}"
              ;;
            *)
              echo "⚠️ Unknown service: ${{ matrix.service }}"
              ;;
          esac
        continue-on-error: true

      - name: Run integration tests for ${{ matrix.service }}
        run: |
          case "${{ matrix.service }}" in
            llm)
              docker run --rm --entrypoint /bin/bash -v $PWD:/workspace ${{ matrix.service }}:${{ github.sha }} -c "source /app/.venv/bin/activate && pytest tests/ -v --tb=short -m 'integration'" || echo "⚠️ No integration tests found or tests failed for ${{ matrix.service }}"
              ;;
            *)
              echo "ℹ️ No integration tests for ${{ matrix.service }}"
              ;;
          esac
        continue-on-error: true

      - name: Generate coverage report for ${{ matrix.service }}
        run: |
          case "${{ matrix.service }}" in
            data-processor|ml_workflow|inference-cloud|llm)
              docker run --rm --entrypoint /bin/bash -v $PWD:/workspace ${{ matrix.service }}:${{ github.sha }} -c "source /app/.venv/bin/activate && pytest tests/ --cov --cov-report=xml --cov-report=html:/workspace/coverage" || true
              ;;
          esac
        continue-on-error: true

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report-${{ matrix.service }}
          path: coverage/
        if: always()
